// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Licitacao {
  id        Int      @id @default(autoincrement())
  nome      String
  municipioId Int?
  municipio   Municipio? @relation(fields: [municipioId], references: [id])
  propostas Proposta[]
  data      DateTime @default(now()) // Manual date field
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Fornecedor {
  id        Int      @id @default(autoincrement())
  nome      String
  contato   String?
  whatsapp  String?
  email     String?
  cnpj      String?
  observacoes String?
  propostas Proposta[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CategoriaProduto {
  id        Int      @id @default(autoincrement())
  nome      String   @unique
  produtos  Produto[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UnidadeMedida {
  id        Int      @id @default(autoincrement())
  sigla     String   @unique // ex: kg, un, m
  nome      String?         // ex: Kilograma, Unidade
  
  produtos       Produto[] @relation("ProdutoUnits")
  produtosLegado Produto[] @relation("LegacyUnit")
  itens          ItemProposta[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Produto {
  id        Int      @id @default(autoincrement())
  nome      String
  
  categoriaId Int?
  categoria   CategoriaProduto? @relation(fields: [categoriaId], references: [id])
  
  // Relação muitos-para-muitos com unidades
  unidades    UnidadeMedida[]   @relation("ProdutoUnits")
  
  // Campo legado para compatibilidade durante migração
  unidadeId   Int?
  unidade     UnidadeMedida?    @relation("LegacyUnit", fields: [unidadeId], references: [id])
  unidadeTexto String? @map("unidade") 

  itens     ItemProposta[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Proposta {
  id           Int      @id @default(autoincrement())
  licitacaoId  Int
  licitacao    Licitacao @relation(fields: [licitacaoId], references: [id])
  fornecedorId Int
  fornecedor   Fornecedor @relation(fields: [fornecedorId], references: [id])
  itens        ItemProposta[]
  data         DateTime @default(now()) // Manual date field
  arquivoUrl   String?  // File upload URL
  observacoes  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model ItemProposta {
  id            Int      @id @default(autoincrement())
  quantidade    Float
  precoUnitario Float
  precoTotal    Float? 
  observacoes   String?

  propostaId    Int
  proposta      Proposta @relation(fields: [propostaId], references: [id], onDelete: Cascade)
  produtoId     Int
  produto       Produto  @relation(fields: [produtoId], references: [id])
  
  unidadeId     Int?
  unidade       UnidadeMedida? @relation(fields: [unidadeId], references: [id])

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Municipio {
  id         Int      @id @default(autoincrement())
  codigoIBGE String   @unique
  nome       String
  uf         String
  nomeCompleto String  // formato "Cidade/UF"
  licitacoes Licitacao[]
  createdAt  DateTime @default(now())
}

model User {
  id        Int      @id @default(autoincrement())
  name      String?
  email     String   @unique
  password  String
  logs      AuditLog[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AuditLog {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  action    String   // "CREATE", "UPDATE", "DELETE"
  entity    String   // "LICITACAO", "FORNECEDOR", "PRODUTO", "PROPOSTA", "ITEM", "USER"
  entityId  Int?
  details   String?  // Descrição rápida ou JSON
  createdAt DateTime @default(now())
}
